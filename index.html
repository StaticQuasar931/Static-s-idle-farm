<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Idle Farm Game</title>
    <style>
        /* Reset and Basic Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #e0f7fa;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
        }

        .dark-mode {
            background-color: #2c3e50;
            color: #ecf0f1;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        /* Resources Display */
        .resources {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .resources div {
            background-color: #ffffff;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Sections */
        .section {
            background-color: #ffffff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: background-color 0.3s, color 0.3s;
        }

        .section h2 {
            margin-bottom: 15px;
            text-align: center;
        }

        /* Containers */
        .container-flex {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Items */
        .item {
            background-color: #f1f1f1;
            border: 2px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            width: 150px;
            text-align: center;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s, background-color 0.3s, color 0.3s;
        }

        .item:hover {
            transform: scale(1.05);
            background-color: #d1e7dd;
        }

        .emoji {
            font-size: 2em;
            margin-bottom: 10px;
        }

        /* Progress Bars */
        .progress-bar {
            width: 100%;
            background-color: #ddd;
            border-radius: 5px;
            overflow: hidden;
            height: 10px;
            margin-top: 10px;
        }

        .progress-bar-inner {
            height: 100%;
            width: 0%;
            background-color: #28a745;
            transition: width 1s linear;
        }

        /* Buttons */
        button {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            background-color: #28a745;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9em;
            margin-top: 10px;
        }

        button:hover {
            background-color: #218838;
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 160px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Position above the element */
            left: 50%;
            margin-left: -80px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Notifications */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .notification {
            background-color: #ffc107;
            color: #212529;
            padding: 10px 20px;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.5s;
        }

        /* In-Game Modals */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1001; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
            transition: background-color 0.3s, color 0.3s;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Auto-Save Notification */
        #auto-save-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #17a2b8;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: none;
            opacity: 0;
            transition: opacity 0.5s;
        }

        /* Toggle Buttons */
        #focus-mode-toggle, #theme-toggle {
            position: fixed;
            top: 20px;
            padding: 10px 15px;
            border-radius: 50%;
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color 0.3s;
        }

        #focus-mode-toggle:hover, #theme-toggle:hover {
            background-color: #0056b3;
        }

        #focus-mode-toggle {
            left: 20px;
        }

        #theme-toggle {
            left: 70px;
        }

        /* Version Display */
        #version-display {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 0.8em;
            color: #555;
        }

        /* Mini-Games Section */
        .minigame-section {
            display: none;
        }

        /* Credits Section */
        .credits {
            text-align: center;
            margin-top: 40px;
            font-size: 0.9em;
            color: #555;
        }

        .credits a {
            color: #007bff;
            text-decoration: none;
        }

        .credits a:hover {
            text-decoration: underline;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .resources {
                flex-direction: column;
                align-items: center;
            }

            .item {
                width: 80%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Idle Farm Game</h1>
        
        <!-- Resources Display -->
        <div class="resources">
            <div>Coins: <span id="coins">0</span></div>
            <div>Gems: <span id="gems">0</span></div>
            <div>Tokens: <span id="tokens">0</span></div>
        </div>
        
        <!-- Crops Section -->
        <div class="section">
            <h2>Crops üå±</h2>
            <div class="container-flex" id="crops-container">
                <!-- Crop Items -->
                <div class="item crop" id="wheat" data-item="wheat" data-reward="10">
                    <div class="emoji">üåæ</div>
                    <h3>Wheat</h3>
                    <p>Growth Time: <span class="growth-time">5</span>s</p>
                    <div class="progress-bar">
                        <div class="progress-bar-inner" id="wheatProgress"></div>
                    </div>
                    <button class="grow-button">Grow</button>
                </div>
                <div class="item crop" id="corn" data-item="corn" data-reward="15">
                    <div class="emoji">üåΩ</div>
                    <h3>Corn</h3>
                    <p>Growth Time: <span class="growth-time">8</span>s</p>
                    <div class="progress-bar">
                        <div class="progress-bar-inner" id="cornProgress"></div>
                    </div>
                    <button class="grow-button">Grow</button>
                </div>
                <div class="item crop" id="pumpkin" data-item="pumpkin" data-reward="25">
                    <div class="emoji">üéÉ</div>
                    <h3>Pumpkin</h3>
                    <p>Growth Time: <span class="growth-time">12</span>s</p>
                    <div class="progress-bar">
                        <div class="progress-bar-inner" id="pumpkinProgress"></div>
                    </div>
                    <button class="grow-button">Grow</button>
                </div>
                <div class="item crop" id="tomato" data-item="tomato" data-reward="20">
                    <div class="emoji">üçÖ</div>
                    <h3>Tomato</h3>
                    <p>Growth Time: <span class="growth-time">7</span>s</p>
                    <div class="progress-bar">
                        <div class="progress-bar-inner" id="tomatoProgress"></div>
                    </div>
                    <button class="grow-button">Grow</button>
                </div>
                <div class="item crop" id="carrot" data-item="carrot" data-reward="12">
                    <div class="emoji">ü•ï</div>
                    <h3>Carrot</h3>
                    <p>Growth Time: <span class="growth-time">6</span>s</p>
                    <div class="progress-bar">
                        <div class="progress-bar-inner" id="carrotProgress"></div>
                    </div>
                    <button class="grow-button">Grow</button>
                </div>
            </div>
        </div>
        
        <!-- Animals Section -->
        <div class="section">
            <h2>Animals üêÑ</h2>
            <div class="container-flex" id="animals-container">
                <!-- Animal Items -->
                <div class="item animal" id="chicken" data-item="chicken" data-reward="20">
                    <div class="emoji">üêî</div>
                    <h3>Chicken</h3>
                    <p>Egg Time: <span class="growth-time">10</span>s</p>
                    <div class="progress-bar">
                        <div class="progress-bar-inner" id="chickenProgress"></div>
                    </div>
                    <button class="collect-button">Collect</button>
                </div>
                <div class="item animal" id="cow" data-item="cow" data-reward="30">
                    <div class="emoji">üêÑ</div>
                    <h3>Cow</h3>
                    <p>Milk Time: <span class="growth-time">15</span>s</p>
                    <div class="progress-bar">
                        <div class="progress-bar-inner" id="cowProgress"></div>
                    </div>
                    <button class="collect-button">Collect</button>
                </div>
                <div class="item animal" id="sheep" data-item="sheep" data-reward="40">
                    <div class="emoji">üêë</div>
                    <h3>Sheep</h3>
                    <p>Wool Time: <span class="growth-time">20</span>s</p>
                    <div class="progress-bar">
                        <div class="progress-bar-inner" id="sheepProgress"></div>
                    </div>
                    <button class="collect-button">Collect</button>
                </div>
                <div class="item animal" id="goat" data-item="goat" data-reward="50">
                    <div class="emoji">üêê</div>
                    <h3>Goat</h3>
                    <p>Milk Time: <span class="growth-time">18</span>s</p>
                    <div class="progress-bar">
                        <div class="progress-bar-inner" id="goatProgress"></div>
                    </div>
                    <button class="collect-button">Collect</button>
                </div>
                <div class="item animal" id="duck" data-item="duck" data-reward="25">
                    <div class="emoji">ü¶Ü</div>
                    <h3>Duck</h3>
                    <p>Egg Time: <span class="growth-time">12</span>s</p>
                    <div class="progress-bar">
                        <div class="progress-bar-inner" id="duckProgress"></div>
                    </div>
                    <button class="collect-button">Collect</button>
                </div>
                <div class="item animal" id="pig" data-item="pig" data-reward="35">
                    <div class="emoji">üêñ</div>
                    <h3>Pig</h3>
                    <p>Truffle Time: <span class="growth-time">25</span>s</p>
                    <div class="progress-bar">
                        <div class="progress-bar-inner" id="pigProgress"></div>
                    </div>
                    <button class="collect-button">Collect</button>
                </div>
            </div>
        </div>
        
        <!-- Upgrades Section -->
        <div class="section">
            <h2>Upgrades üöú</h2>
            <div class="container-flex" id="upgrades-container">
                <!-- Upgrade Items -->
                <div class="item upgrade tooltip" data-upgrade="fertilizer" data-cost="50">
                    <h3>Buy Fertilizer</h3>
                    <p>(50 coins)</p>
                    <span class="tooltiptext">Reduces wheat and chicken growth times by 1s.</span>
                </div>
                <div class="item upgrade tooltip" data-upgrade="tractor" data-cost="150">
                    <h3>Buy Tractor</h3>
                    <p>(150 coins)</p>
                    <span class="tooltiptext">Reduces corn and cow production times by 2s.</span>
                </div>
                <div class="item upgrade tooltip" data-upgrade="barn" data-cost="300">
                    <h3>Buy Barn</h3>
                    <p>(300 coins)</p>
                    <span class="tooltiptext">Allows you to keep more animals.</span>
                </div>
                <div class="item upgrade tooltip" data-upgrade="greenhouse" data-cost="500">
                    <h3>Buy Greenhouse</h3>
                    <p>(500 coins)</p>
                    <span class="tooltiptext">Reduces pumpkin growth time by 3s.</span>
                </div>
                <div class="item upgrade tooltip" data-upgrade="irrigation" data-cost="800">
                    <h3>Buy Irrigation</h3>
                    <p>(800 coins)</p>
                    <span class="tooltiptext">Reduces wheat and corn growth times by 2s.</span>
                </div>
                <div class="item upgrade tooltip" data-upgrade="windmill" data-cost="1000">
                    <h3>Buy Windmill</h3>
                    <p>(1000 coins)</p>
                    <span class="tooltiptext">Reduces sheep and goat production times by 5s.</span>
                </div>
                <div class="item upgrade tooltip" data-upgrade="market" data-cost="2000">
                    <h3>Buy Market</h3>
                    <p>(2000 coins)</p>
                    <span class="tooltiptext">Increases coin rewards by 10%.</span>
                </div>
                <div class="item upgrade tooltip" data-upgrade="advancedTractor" data-cost="5000">
                    <h3>Advanced Tractor</h3>
                    <p>(5000 coins)</p>
                    <span class="tooltiptext">Further reduces corn and cow production times by 3s.</span>
                </div>
                <div class="item upgrade tooltip" data-upgrade="superWindmill" data-cost="8000">
                    <h3>Super Windmill</h3>
                    <p>(8000 coins)</p>
                    <span class="tooltiptext">Further reduces sheep and goat production times by 5s.</span>
                </div>
            </div>
        </div>
        
        <!-- Passive Farms Section -->
        <div class="section">
            <h2>Passive Farms üåæ</h2>
            <div class="container-flex" id="passive-farms-container">
                <!-- Passive Farm Items -->
                <div class="item passive-farm" id="passiveCrop1" data-farm="passiveCrop1" data-cost="500" data-interval="10000" data-amount="5">
                    <h3>Passive Wheat Farm</h3>
                    <p>Cost: 500 coins</p>
                    <p>Generates 5 coins every 10s</p>
                </div>
                <div class="item passive-farm" id="passiveAnimal1" data-farm="passiveAnimal1" data-cost="1000" data-interval="20000" data-amount="15">
                    <h3>Passive Chicken Coop</h3>
                    <p>Cost: 1000 coins</p>
                    <p>Generates 15 coins every 20s</p>
                </div>
            </div>
        </div>
        
        <!-- Decorations Section -->
        <div class="section">
            <h2>Decorations üé®</h2>
            <div class="container-flex" id="decorations-container">
                <!-- Decoration Items -->
                <div class="item decoration tooltip" data-decoration="statue" data-cost="300">
                    <h3>Statue</h3>
                    <p>(300 coins)</p>
                    <span class="tooltiptext">Beautify your farm. No gameplay effect.</span>
                </div>
                <div class="item decoration tooltip" data-decoration="fountain" data-cost="500">
                    <h3>Fountain</h3>
                    <p>(500 coins)</p>
                    <span class="tooltiptext">Adds a fountain to your farm. No gameplay effect.</span>
                </div>
                <!-- Add more decorations as needed -->
            </div>
        </div>
        
        <!-- Quests Section -->
        <div class="section">
            <h2>Quests üéØ</h2>
            <div class="container-flex" id="quests-container">
                <!-- Quests will be dynamically added here -->
            </div>
        </div>
        
        <!-- Achievements Section -->
        <div class="section">
            <h2>Achievements üèÜ</h2>
            <div class="container-flex" id="achievements-container">
                <!-- Achievements will be dynamically added here -->
            </div>
        </div>
        
        <!-- Pets Section -->
        <div class="section">
            <h2>Pets üêæ</h2>
            <div class="container-flex" id="pets-container">
                <!-- Pets will be dynamically added here -->
                <div class="item pet" id="spinPetWheel">
                    <h3>Spin Pet Wheel</h3>
                    <p>(10 Tokens)</p>
                    <button id="spinPetButton">Spin</button>
                </div>
            </div>
        </div>
        
        <!-- Black Market Section -->
        <div class="section">
            <h2>Black Market üí±</h2>
            <div class="container-flex" id="blackmarket-container">
                <!-- Black Market items will be dynamically added here -->
            </div>
        </div>
        
        <!-- Mini Games Section -->
        <div class="section">
            <h2>Mini Games üïπÔ∏è</h2>
            <div class="container-flex" id="minigame-container">
                <div class="item minigame tooltip" data-game="flappyFarm">
                    <h3>Flappy Farm üê•</h3>
                    <p>Play and earn tokens!</p>
                    <span class="tooltiptext">A simple Flappy Bird-like game to earn tokens.</span>
                    <button class="play-game-button">Play</button>
                </div>
                <div class="item minigame tooltip" data-game="memoryMatch">
                    <h3>Memory Match üß†</h3>
                    <p>Test your memory!</p>
                    <span class="tooltiptext">Match pairs to earn tokens.</span>
                    <button class="play-game-button">Play</button>
                </div>
                <!-- Add more Mini Games as needed -->
            </div>
        </div>
        
        <!-- Prestige Section -->
        <div class="section">
            <h2>Prestige ‚ú®</h2>
            <button id="prestigeButton">Reset for Prestige (1000 Coins)</button>
            <p>Prestige Count: <span id="prestigeCount">0</span></p>
            <p>Coin Multiplier: x<span id="coinMultiplier">1</span></p>
        </div>
        
        <!-- Settings Section -->
        <div class="section">
            <h2>Settings ‚öôÔ∏è</h2>
            <button id="openSettingsButton">Open Settings</button>
        </div>
        
        <!-- Help Section -->
        <div class="section">
            <h2>Help ‚ùì</h2>
            <button id="openHelpButton">Open Help</button>
        </div>
        
        <!-- Mini Games Sections -->
        <div class="section minigame-section" id="flappyFarmSection">
            <h2>Flappy Farm üê•</h2>
            <canvas id="flappyCanvas" width="400" height="600" style="background-color: skyblue;"></canvas>
            <button id="backToMainFromFlappy">Back to Main Game</button>
        </div>
        
        <div class="section minigame-section" id="memoryMatchSection">
            <h2>Memory Match üß†</h2>
            <div id="memoryGameBoard" style="display: grid; grid-template-columns: repeat(4, 100px); grid-gap: 10px; justify-content: center; margin-top: 20px;">
                <!-- Memory cards will be dynamically generated here -->
            </div>
            <button id="backToMainFromMemory">Back to Main Game</button>
        </div>
        
        <!-- Notification Container -->
        <div id="notification-container"></div>
        
        <!-- In-Game Modals -->
        <!-- Tutorial Modal -->
        <div id="tutorialModal" class="modal">
            <div class="modal-content">
                <span class="close" data-close="tutorialModal">&times;</span>
                <h2>Welcome to Idle Farm!</h2>
                <p>Let's get you started with a quick tutorial.</p>
                <button id="nextTutorialButton">Next</button>
            </div>
        </div>
        
        <!-- Prestige Confirmation Modal -->
        <div id="prestigeModal" class="modal">
            <div class="modal-content">
                <span class="close" data-close="prestigeModal">&times;</span>
                <h2>Confirm Prestige</h2>
                <p>Are you sure you want to reset your progress for a Prestige?</p>
                <button id="confirmPrestigeButton">Yes, Prestige</button>
                <button id="cancelPrestigeButton">Cancel</button>
            </div>
        </div>
        
        <!-- Settings Modal -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <span class="close" data-close="settingsModal">&times;</span>
                <h2>Settings</h2>
                <button id="restartTutorialButton">Restart Tutorial</button>
                <button id="resetProgressButton">Restart Progress</button>
                <button id="closeSettingsButton">Close</button>
            </div>
        </div>
        
        <!-- Reset Progress Confirmation Modal -->
        <div id="resetProgressModal" class="modal">
            <div class="modal-content">
                <span class="close" data-close="resetProgressModal">&times;</span>
                <h2>Confirm Reset</h2>
                <p>Are you sure you want to reset all your progress?</p>
                <button id="confirmResetButton">Yes, Reset</button>
                <button id="cancelResetButton">Cancel</button>
            </div>
        </div>
        
        <!-- Help Modal -->
        <div id="helpModal" class="modal">
            <div class="modal-content">
                <span class="close" data-close="helpModal">&times;</span>
                <h2>Help & Information</h2>
                <p>Welcome to Idle Farm! Here's how to play:</p>
                <ul>
                    <li><strong>Crops:</strong> Click on crops to grow them. Once grown, collect coins.</li>
                    <li><strong>Animals:</strong> Raise animals to produce products. Click to collect coins.</li>
                    <li><strong>Upgrades:</strong> Purchase upgrades to enhance production and reduce growth times.</li>
                    <li><strong>Passive Farms:</strong> Buy passive farms that generate coins automatically at intervals.</li>
                    <li><strong>Decorations:</strong> Beautify your farm with decorations. No gameplay effect.</li>
                    <li><strong>Quests:</strong> Complete quests to earn additional rewards.</li>
                    <li><strong>Achievements:</strong> Unlock achievements based on your progress.</li>
                    <li><strong>Pets:</strong> Spin the pet wheel to collect pets that provide various benefits.</li>
                    <li><strong>Black Market:</strong> Purchase rare animals that boost your earnings.</li>
                    <li><strong>Mini Games:</strong> Play mini-games to earn tokens.</li>
                    <li><strong>Prestige:</strong> Reset your progress for increased multipliers and long-term rewards.</li>
                    <li><strong>Settings:</strong> Access settings to restart the tutorial or reset your progress.</li>
                </ul>
                <button id="closeHelpButton">Close</button>
            </div>
        </div>
        
        <!-- NPC Trading Modal -->
        <div id="npcModal" class="modal">
            <div class="modal-content">
                <span class="close" data-close="npcModal">&times;</span>
                <!-- NPC trading content will be dynamically injected here -->
            </div>
        </div>
        
        <!-- Notification Container -->
        <div id="notification-container"></div>
        
        <!-- Auto-Save Notification -->
        <div id="auto-save-notification">Game has been auto-saved! ‚úÖ</div>
        
        <!-- Toggle Buttons -->
        <button id="focus-mode-toggle">üîí</button>
        <button id="theme-toggle">üåó</button>
        
        <!-- Version Display -->
        <div id="version-display">V0.0.02.00</div>
        
        <!-- Credits Section -->
        <div class="credits">
            <p>Game developed by <a href="https://github.com/Static" target="_blank">Static</a></p>
        </div>
    </div>
    
    <script>
        // Game Variables
        let coins = 0;
        let gems = 0;
        let tokens = 0;
        let growthTimers = {};
        let passiveTimers = {};
        let growthTimes = {
            wheat: 5,
            corn: 8,
            pumpkin: 12,
            tomato: 7,
            carrot: 6,
            chicken: 10,
            cow: 15,
            sheep: 20,
            goat: 18,
            duck: 12,
            pig: 25
        };
        let baseRewards = {
            wheat: 10,
            corn: 15,
            pumpkin: 25,
            tomato: 20,
            carrot: 12,
            chicken: 20,
            cow: 30,
            sheep: 40,
            goat: 50,
            duck: 25,
            pig: 35
        };
        let achievements = {};
        let quests = [];
        let completedQuests = [];
        let prestigeCount = 0;
        let coinMultiplier = 1;
        let focusMode = false;
        let theme = 'light';
        let dailyBonusClaimed = false;
        let playerNetWorth = 0;
        let ownedPets = [];
        let equippedPets = [];
        const version = 'V0.0.02.00';
        
        // NPC Trading Variables
        let npcs = generateNPCs();
        
        // Tutorial Variables
        let tutorialStep = 0;
        const totalTutorialSteps = 5;
        let isTutorialActive = false;
        
        // Initialization
        window.onload = function() {
            loadGame();
            generateQuests();
            generateAchievements();
            updateResources();
            renderQuests();
            renderAchievements();
            renderBlackMarket();
            renderOwnedPets();
            updatePrestige();
            renderVersion();
            checkDailyBonus();
            startPassiveIncome();
            updateTheme();
            showAutoSaveNotification();
            startNPCAutoContact();
            checkAndStartTutorial();
            attachEventListeners();
            initializeMiniGames();
            renderCredits();
        };
        
        window.onbeforeunload = saveGame;
        
        // Attach Event Listeners
        function attachEventListeners() {
            // Grow Crop Buttons
            document.querySelectorAll('.grow-button').forEach(button => {
                button.addEventListener('click', function(event) {
                    const cropDiv = event.target.closest('.crop');
                    const item = cropDiv.getAttribute('data-item');
                    const reward = parseInt(cropDiv.getAttribute('data-reward'));
                    growCrop(item, reward);
                });
            });

            // Collect Animal Buttons
            document.querySelectorAll('.collect-button').forEach(button => {
                button.addEventListener('click', function(event) {
                    const animalDiv = event.target.closest('.animal');
                    const item = animalDiv.getAttribute('data-item');
                    const reward = parseInt(animalDiv.getAttribute('data-reward'));
                    collectAnimal(item, reward);
                });
            });

            // Upgrade Buttons
            document.querySelectorAll('.upgrade').forEach(upgrade => {
                upgrade.addEventListener('click', function(event) {
                    const upgradeName = upgrade.getAttribute('data-upgrade');
                    const cost = parseInt(upgrade.getAttribute('data-cost'));
                    buyUpgrade(upgradeName, cost);
                });
            });

            // Passive Farm Buttons
            document.querySelectorAll('.passive-farm').forEach(farm => {
                farm.addEventListener('click', function(event) {
                    const farmId = farm.getAttribute('data-farm');
                    const cost = parseInt(farm.getAttribute('data-cost'));
                    buyPassiveFarm(farmId, cost);
                });
            });

            // Decoration Buttons
            document.querySelectorAll('.decoration').forEach(decoration => {
                decoration.addEventListener('click', function(event) {
                    const decorationName = decoration.getAttribute('data-decoration');
                    const cost = parseInt(decoration.getAttribute('data-cost'));
                    buyDecoration(decorationName, cost);
                });
            });

            // Spin Pet Wheel Button
            const spinPetButton = document.getElementById('spinPetButton');
            if (spinPetButton) {
                spinPetButton.addEventListener('click', function() {
                    spinPetWheel();
                });
            }

            // Mini Game Play Buttons
            document.querySelectorAll('.play-game-button').forEach(button => {
                button.addEventListener('click', function(event) {
                    const gameDiv = event.target.closest('.minigame');
                    const gameName = gameDiv.getAttribute('data-game');
                    openMiniGame(gameName);
                });
            });

            // Prestige Button
            const prestigeButton = document.getElementById('prestigeButton');
            if (prestigeButton) {
                prestigeButton.addEventListener('click', function() {
                    openPrestigeModal();
                });
            }

            // Settings Buttons
            const openSettingsButton = document.getElementById('openSettingsButton');
            if (openSettingsButton) {
                openSettingsButton.addEventListener('click', function() {
                    openSettingsModal();
                });
            }

            // Help Buttons
            const openHelpButton = document.getElementById('openHelpButton');
            if (openHelpButton) {
                openHelpButton.addEventListener('click', function() {
                    openHelpModal();
                });
            }

            // Modal Close Buttons
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', function(event) {
                    const modalId = closeBtn.getAttribute('data-close');
                    closeModal(modalId);
                });
            });

            // Back to Main Game Buttons
            const backToMainFromFlappyButton = document.getElementById('backToMainFromFlappy');
            if (backToMainFromFlappyButton) {
                backToMainFromFlappyButton.addEventListener('click', function() {
                    backToMainFromFlappy();
                });
            }

            const backToMainFromMemoryButton = document.getElementById('backToMainFromMemory');
            if (backToMainFromMemoryButton) {
                backToMainFromMemoryButton.addEventListener('click', function() {
                    backToMainFromMemory();
                });
            }
        }
        
        // Update Resources Display
        function updateResources() {
            document.getElementById('coins').innerText = Math.floor(coins);
            document.getElementById('gems').innerText = gems;
            document.getElementById('tokens').innerText = tokens;
        }
        
        // Update Prestige Display
        function updatePrestige() {
            document.getElementById('prestigeCount').innerText = prestigeCount;
            document.getElementById('coinMultiplier').innerText = coinMultiplier.toFixed(1);
        }
        
        // Render Version
        function renderVersion() {
            document.getElementById('version-display').innerText = version;
        }
        
        // Grow Crop Function
        function growCrop(item, reward) {
            if (!growthTimers[item]) {
                startProgressBar(item);
                growthTimers[item] = setTimeout(() => {
                    coins += reward * coinMultiplier;
                    playerNetWorth += reward * coinMultiplier;
                    updateResources();
                    showNotification(`${capitalize(item)} collected! +${Math.floor(reward * coinMultiplier)} coins`);
                    clearTimeout(growthTimers[item]);
                    growthTimers[item] = null;
                    checkAchievements(item, 'crop');
                    checkQuests(item, 'crop');
                    resetProgressBar(item);
                }, growthTimes[item] * 1000);
            } else {
                showNotification(`${capitalize(item)} is already growing!`);
            }
        }
        
        // Collect Animal Function
        function collectAnimal(animal, reward) {
            if (!growthTimers[animal]) {
                startProgressBar(animal);
                growthTimers[animal] = setTimeout(() => {
                    coins += reward * coinMultiplier;
                    playerNetWorth += reward * coinMultiplier;
                    updateResources();
                    showNotification(`${capitalize(animal)} product collected! +${Math.floor(reward * coinMultiplier)} coins`);
                    clearTimeout(growthTimers[animal]);
                    growthTimers[animal] = null;
                    checkAchievements(animal, 'animal');
                    checkQuests(animal, 'animal');
                    resetProgressBar(animal);
                }, growthTimes[animal] * 1000);
            } else {
                showNotification(`${capitalize(animal)} is already producing!`);
            }
        }
        
        // Start Progress Bar Function
        function startProgressBar(item) {
            const progressBar = document.getElementById(`${item}Progress`);
            if (progressBar) {
                progressBar.style.width = '0%';
                let duration = growthTimes[item];
                let interval = setInterval(() => {
                    if (duration <= 0) {
                        clearInterval(interval);
                        progressBar.style.width = '100%';
                    } else {
                        progressBar.style.width = `${((growthTimes[item] - duration) / growthTimes[item]) * 100}%`;
                        duration--;
                    }
                }, 1000);
            }
        }

        // Reset Progress Bar
        function resetProgressBar(item) {
            const progressBar = document.getElementById(`${item}Progress`);
            if (progressBar) {
                progressBar.style.width = '0%';
            }
        }
        
        // Passive Farms Functions
        function buyPassiveFarm(id, cost) {
            if (coins >= cost && !document.getElementById(id).classList.contains('owned')) {
                coins -= cost;
                document.getElementById(id).classList.add('owned');
                showNotification(`Passive Farm purchased! üí∞ Generates coins passively.`);
                startPassiveIncomeItem(id);
                updateResources();
                playerNetWorth += cost;
                checkAchievements(null, 'passive');
                saveGame();
            } else {
                showNotification('Not enough coins or already owned!');
            }
        }
        
        function startPassiveIncomeItem(id) {
            const farmDiv = document.getElementById(id);
            if (farmDiv) {
                const interval = parseInt(farmDiv.getAttribute('data-interval'));
                const amount = parseInt(farmDiv.getAttribute('data-amount'));
                passiveTimers[id] = setInterval(() => {
                    coins += amount * coinMultiplier;
                    playerNetWorth += amount * coinMultiplier;
                    updateResources();
                    showNotification(`Passive income: +${Math.floor(amount * coinMultiplier)} coins from Passive Farm.`);
                }, interval);
            }
        }
        
        function startPassiveIncome() {
            // Initialize existing passive farms
            document.querySelectorAll('.passive-farm.owned').forEach(farm => {
                const farmId = farm.getAttribute('data-farm');
                startPassiveIncomeItem(farmId);
            });
        }
        
        // Buy Upgrades Function
        function buyUpgrade(upgradeName, cost) {
            if (coins >= cost) {
                coins -= cost;
                playerNetWorth += cost;
                updateResources();
                
                switch(upgradeName) {
                    case 'fertilizer':
                        growthTimes.wheat = Math.max(1, growthTimes.wheat - 1);
                        growthTimes.chicken = Math.max(5, growthTimes.chicken - 1);
                        showNotification('Fertilizer purchased! üå± Wheat and Chicken growth times decreased by 1s.');
                        break;
                    case 'tractor':
                        growthTimes.corn = Math.max(4, growthTimes.corn - 2);
                        growthTimes.cow = Math.max(10, growthTimes.cow - 2);
                        showNotification('Tractor purchased! üöú Corn and Cow production times decreased by 2s.');
                        break;
                    case 'barn':
                        // Implement barn functionality if needed
                        showNotification('Barn purchased! üè† You can now keep more animals!');
                        break;
                    case 'greenhouse':
                        growthTimes.pumpkin = Math.max(6, growthTimes.pumpkin - 3);
                        showNotification('Greenhouse purchased! üåø Pumpkin growth time decreased by 3s.');
                        break;
                    case 'irrigation':
                        growthTimes.wheat = Math.max(1, growthTimes.wheat - 2);
                        growthTimes.corn = Math.max(2, growthTimes.corn - 2);
                        showNotification('Irrigation System purchased! üí¶ Wheat and Corn growth times decreased by 2s.');
                        break;
                    case 'windmill':
                        growthTimes.sheep = Math.max(10, growthTimes.sheep - 5);
                        growthTimes.goat = Math.max(10, growthTimes.goat - 5);
                        showNotification('Windmill purchased! üå¨Ô∏è Sheep and Goat production times decreased by 5s.');
                        break;
                    case 'market':
                        coinMultiplier += 0.1;
                        showNotification('Market purchased! üíº Coin rewards increased by 10%.');
                        break;
                    case 'advancedTractor':
                        growthTimes.corn = Math.max(2, growthTimes.corn - 3);
                        growthTimes.cow = Math.max(7, growthTimes.cow - 3);
                        showNotification('Advanced Tractor purchased! üöú Corn and Cow production times decreased by 3s.');
                        break;
                    case 'superWindmill':
                        growthTimes.sheep = Math.max(5, growthTimes.sheep - 5);
                        growthTimes.goat = Math.max(5, growthTimes.goat - 5);
                        showNotification('Super Windmill purchased! üå¨Ô∏è Sheep and Goat production times decreased by 5s.');
                        break;
                    default:
                        break;
                }
                
                checkAchievements(upgradeName, 'upgrade');
                checkQuests(upgradeName, 'upgrade');
                saveGame();
            } else {
                showNotification('Not enough coins!');
            }
        }
        
        // Buy Decorations Function
        function buyDecoration(decoration, cost) {
            if (coins >= cost) {
                coins -= cost;
                showNotification(`${capitalize(decoration)} decoration added to your farm! üéâ`);
                updateResources();
                playerNetWorth += cost;
                checkAchievements(decoration, 'decoration');
                saveGame();
            } else {
                showNotification('Not enough coins!');
            }
        }
        
        // Quests System
        function generateQuests() {
            const questList = [
                { id: 'quest1', description: 'Harvest 20 Wheat', goal: 20, type: 'crop', item: 'wheat', reward: '100 Coins' },
                { id: 'quest2', description: 'Collect 500 Coins', goal: 500, type: 'coins', item: null, reward: '50 Coins' },
                { id: 'quest3', description: 'Buy 2 Upgrades', goal: 2, type: 'upgrade', item: null, reward: '150 Coins' },
                { id: 'quest4', description: 'Raise 10 Chickens', goal: 10, type: 'animal', item: 'chicken', reward: '200 Coins' },
                { id: 'quest5', description: 'Own 1 Passive Farm', goal: 1, type: 'passive', item: null, reward: '300 Coins' },
                { id: 'quest6', description: 'Play 5 Mini Games', goal: 5, type: 'minigame', item: null, reward: '50 Tokens' },
                { id: 'quest7', description: 'Own 3 Pets', goal: 3, type: 'pet', item: null, reward: '100 Tokens' },
                { id: 'quest8', description: 'Trade with 2 NPCs', goal: 2, type: 'npc', item: null, reward: '150 Tokens' }
            ];
            quests = questList.filter(q => !completedQuests.includes(q.id));
        }
        
        function checkQuests(item, type) {
            quests.forEach(quest => {
                if (!completedQuests.includes(quest.id)) {
                    switch(quest.type) {
                        case 'crop':
                            if (quest.item === item) {
                                quest.count = (quest.count || 0) + 1;
                                if (quest.count >= quest.goal) {
                                    completeQuest(quest);
                                }
                            }
                            break;
                        case 'animal':
                            if (quest.item === item) {
                                quest.count = (quest.count || 0) + 1;
                                if (quest.count >= quest.goal) {
                                    completeQuest(quest);
                                }
                            }
                            break;
                        case 'coins':
                            if (coins >= quest.goal) {
                                completeQuest(quest);
                            }
                            break;
                        case 'upgrade':
                            quest.count = (quest.count || 0) + 1;
                            if (quest.count >= quest.goal) {
                                completeQuest(quest);
                            }
                            break;
                        case 'passive':
                            if (getOwnedPassiveFarms().length >= quest.goal) {
                                completeQuest(quest);
                            }
                            break;
                        case 'minigame':
                            quest.count = (quest.count || 0) + 1;
                            if (quest.count >= quest.goal) {
                                completeQuest(quest);
                            }
                            break;
                        case 'pet':
                            if (ownedPets.length >= quest.goal) {
                                completeQuest(quest);
                            }
                            break;
                        case 'npc':
                            quest.count = (quest.count || 0) + 1;
                            if (quest.count >= quest.goal) {
                                completeQuest(quest);
                            }
                            break;
                        default:
                            break;
                    }
                }
            });
        }
        
        function completeQuest(quest) {
            let reward = quest.reward;
            if (reward.includes('Gems')) {
                gems += parseInt(reward);
            } else if (reward.includes('Tokens')) {
                tokens += parseInt(reward);
            } else if (reward.includes('Coins')) {
                coins += parseInt(reward);
                playerNetWorth += parseInt(reward);
            }
            showNotification(`Quest Completed: ${quest.description} +${reward}`);
            completedQuests.push(quest.id);
            quests = quests.filter(q => q.id !== quest.id);
            generateQuests();
            renderQuests();
            updateResources();
            checkAchievements(quest.item, quest.type);
            saveGame();
        }
        
        function renderQuests() {
            const container = document.getElementById('quests-container');
            container.innerHTML = '';
            quests.forEach(quest => {
                if (!completedQuests.includes(quest.id)) {
                    let questDiv = document.createElement('div');
                    questDiv.classList.add('item', 'quest');
                    questDiv.innerHTML = `<h4>${quest.description}</h4><p>Reward: ${quest.reward}</p>`;
                    container.appendChild(questDiv);
                }
            });
        }
        
        // Achievements System
        function generateAchievements() {
            const achievementList = [
                { id: 'ach1', description: 'Harvest 10 Wheat', goal: 10, type: 'crop', item: 'wheat', reward: '10 Gems' },
                { id: 'ach2', description: 'Harvest 50 Corn', goal: 50, type: 'crop', item: 'corn', reward: '20 Gems' },
                { id: 'ach3', description: 'Collect 1000 Coins', goal: 1000, type: 'coins', item: null, reward: '50 Gems' },
                { id: 'ach4', description: 'Raise 20 Chickens', goal: 20, type: 'animal', item: 'chicken', reward: '30 Gems' },
                { id: 'ach5', description: 'Unlock Market Upgrade', goal: 'market', type: 'upgrade', item: 'market', reward: '100 Gems' },
                { id: 'ach6', description: 'Prestige 1 Time', goal: 1, type: 'prestige', item: null, reward: '150 Gems' },
                { id: 'ach7', description: 'Own 1 Passive Farm', goal: 1, type: 'passive', item: null, reward: '200 Gems' },
                { id: 'ach8', description: 'Play 5 Mini Games', goal: 5, type: 'minigame', item: null, reward: '50 Tokens' },
                { id: 'ach9', description: 'Own 3 Pets', goal: 3, type: 'pet', item: null, reward: '100 Tokens' },
                { id: 'ach10', description: 'Trade with 2 NPCs', goal: 2, type: 'npc', item: null, reward: '200 Tokens' }
            ];
            achievementList.forEach(ach => {
                if (!achievements[ach.id]) {
                    achievements[ach.id] = { ...ach, achieved: false, count: 0 };
                }
            });
        }
        
        function checkAchievements(item, type) {
            for (let key in achievements) {
                let ach = achievements[key];
                if (!ach.achieved) {
                    switch(ach.type) {
                        case 'crop':
                            if (ach.item === item) {
                                ach.count += 1;
                                if (ach.count >= ach.goal) {
                                    ach.achieved = true;
                                    if (ach.reward.includes('Gems')) {
                                        gems += parseInt(ach.reward);
                                    }
                                    showNotification(`Achievement Unlocked: ${ach.description} +${ach.reward}`);
                                }
                            }
                            break;
                        case 'animal':
                            if (ach.item === item) {
                                ach.count += 1;
                                if (ach.count >= ach.goal) {
                                    ach.achieved = true;
                                    if (ach.reward.includes('Gems')) {
                                        gems += parseInt(ach.reward);
                                    }
                                    showNotification(`Achievement Unlocked: ${ach.description} +${ach.reward}`);
                                }
                            }
                            break;
                        case 'coins':
                            if (coins >= ach.goal) {
                                ach.achieved = true;
                                gems += parseInt(ach.reward);
                                showNotification(`Achievement Unlocked: ${ach.description} +${ach.reward}`);
                            }
                            break;
                        case 'upgrade':
                            if (ach.item === item && item === 'market' && coinMultiplier > 1) {
                                ach.achieved = true;
                                gems += parseInt(ach.reward);
                                showNotification(`Achievement Unlocked: ${ach.description} +${ach.reward}`);
                            }
                            break;
                        case 'prestige':
                            if (prestigeCount >= ach.goal) {
                                ach.achieved = true;
                                gems += parseInt(ach.reward);
                                showNotification(`Achievement Unlocked: ${ach.description} +${ach.reward}`);
                            }
                            break;
                        case 'passive':
                            if (getOwnedPassiveFarms().length >= ach.goal) {
                                ach.achieved = true;
                                gems += parseInt(ach.reward);
                                showNotification(`Achievement Unlocked: ${ach.description} +${ach.reward}`);
                            }
                            break;
                        case 'minigame':
                            ach.count += 1;
                            if (ach.count >= ach.goal) {
                                ach.achieved = true;
                                tokens += parseInt(ach.reward);
                                showNotification(`Achievement Unlocked: ${ach.description} +${ach.reward}`);
                            }
                            break;
                        case 'pet':
                            if (ownedPets.length >= ach.goal) {
                                ach.achieved = true;
                                tokens += parseInt(ach.reward);
                                showNotification(`Achievement Unlocked: ${ach.description} +${ach.reward}`);
                            }
                            break;
                        case 'npc':
                            ach.count += 1;
                            if (ach.count >= ach.goal) {
                                ach.achieved = true;
                                tokens += parseInt(ach.reward);
                                showNotification(`Achievement Unlocked: ${ach.description} +${ach.reward}`);
                            }
                            break;
                        default:
                            break;
                    }
                }
            }
            renderAchievements();
            updateResources();
        }
        
        function renderAchievements() {
            const container = document.getElementById('achievements-container');
            container.innerHTML = '';
            for (let key in achievements) {
                let ach = achievements[key];
                let achDiv = document.createElement('div');
                achDiv.classList.add('item', 'achievement');
                achDiv.innerHTML = `<h4>${ach.achieved ? '‚úÖ' : 'üîÑ'} ${ach.description}</h4><p>Reward: ${ach.reward}</p>`;
                container.appendChild(achDiv);
            }
        }
        
        // Black Market System
        function generateBlackMarketItems() {
            const baseAnimals = ['üê∂', 'üê±', 'ü¶ä', 'üê∞', 'üêª'];
            const rarities = ['Common', 'Uncommon', 'Rare', 'Epic', 'Mythic'];
            let blackMarketItems = [];
            baseAnimals.forEach(animal => {
                rarities.forEach(rarity => {
                    let cost = 100;
                    switch(rarity) {
                        case 'Common':
                            cost = 100;
                            break;
                        case 'Uncommon':
                            cost = 300;
                            break;
                        case 'Rare':
                            cost = 600;
                            break;
                        case 'Epic':
                            cost = 1000;
                            break;
                        case 'Mythic':
                            cost = 2000;
                            break;
                        default:
                            cost = 100;
                            break;
                    }
                    blackMarketItems.push({
                        animal: animal,
                        rarity: rarity,
                        cost: cost,
                        benefits: getBenefitsByRarity(rarity)
                    });
                });
            });
            return blackMarketItems;
        }
        
        function getBenefitsByRarity(rarity) {
            switch(rarity) {
                case 'Common':
                    return { coinBoost: 1 };
                case 'Uncommon':
                    return { coinBoost: 1.5 };
                case 'Rare':
                    return { coinBoost: 2 };
                case 'Epic':
                    return { coinBoost: 3 };
                case 'Mythic':
                    return { coinBoost: 5 };
                default:
                    return { coinBoost: 1 };
            }
        }
        
        function renderBlackMarket() {
            const blackMarketItems = generateBlackMarketItems();
            const container = document.getElementById('blackmarket-container');
            container.innerHTML = '';
            blackMarketItems.forEach((item, index) => {
                let itemDiv = document.createElement('div');
                itemDiv.classList.add('item', 'blackmarket');
                itemDiv.innerHTML = `
                    <div class="emoji">${item.animal}</div>
                    <h3>${item.rarity} Animal</h3>
                    <p>Cost: ${item.cost} coins</p>
                    <button data-index="${index}" class="buy-blackmarket-item">Buy</button>
                `;
                container.appendChild(itemDiv);
            });
            
            // Attach event listeners for black market items
            document.querySelectorAll('.buy-blackmarket-item').forEach(button => {
                button.addEventListener('click', function(event) {
                    const index = parseInt(event.target.getAttribute('data-index'));
                    buyBlackMarketItem(index);
                });
            });
        }
        
        function buyBlackMarketItem(index) {
            const blackMarketItems = generateBlackMarketItems();
            const item = blackMarketItems[index];
            if (coins >= item.cost) {
                coins -= item.cost;
                tokens += 1; // Reward token for purchase
                playerNetWorth += item.cost;
                showNotification(`Purchased ${item.rarity} Animal ${item.animal}! +${item.benefits.coinBoost}x coins from this animal.`);
                addBlackMarketAnimal(item);
                updateResources();
                checkAchievements(getAnimalName(item.animal), 'animal');
                saveGame();
            } else {
                showNotification('Not enough coins!');
            }
        }
        
        function addBlackMarketAnimal(item) {
            // Add to animal section with benefits
            const animalContainer = document.getElementById('animals-container');
            let animalName = getAnimalName(item.animal) + 'Special';
            let existingAnimal = document.getElementById(animalName);
            if (existingAnimal) {
                // If already exists, increment count and update coin boost
                let countSpan = existingAnimal.querySelector('.count');
                let currentCount = parseInt(countSpan.innerText);
                countSpan.innerText = currentCount + 1;
                // Update coin boost
                let coinBoostPara = existingAnimal.querySelector('p.coin-boost');
                let newBoost = 1 + (item.benefits.coinBoost - 1) * currentCount;
                coinBoostPara.innerText = `Coin Boost: x${newBoost.toFixed(1)}`;
            } else {
                // Create new animal with benefits
                let newAnimal = document.createElement('div');
                newAnimal.classList.add('item', 'animal');
                newAnimal.id = animalName;
                newAnimal.innerHTML = `
                    <div class="emoji">${item.animal}</div>
                    <h3>${getAnimalName(item.animal)} (${item.rarity})</h3>
                    <p class="coin-boost">Coin Boost: x${item.benefits.coinBoost}</p>
                    <p>Owned: <span class="count">1</span></p>
                    <button data-animalid="${animalName}" data-basecost="${item.cost}" class="buy-more-special">Buy More</button>
                `;
                animalContainer.appendChild(newAnimal);
            }
            
            // Attach event listener for "Buy More" button
            document.querySelectorAll('.buy-more-special').forEach(button => {
                button.addEventListener('click', function(event) {
                    const animalId = event.target.getAttribute('data-animalid');
                    const baseCost = parseInt(event.target.getAttribute('data-basecost'));
                    buyMoreSpecial(animalId, baseCost);
                });
            });
        }
        
        function buyMoreSpecial(animalId, baseCost) {
            let countSpan = document.getElementById(animalId).querySelector('.count');
            let count = parseInt(countSpan.innerText);
            let cost = Math.floor(baseCost * Math.pow(1.5, count)); // Increasing cost
            if (coins >= cost) {
                coins -= cost;
                countSpan.innerText = count + 1;
                tokens += 1; // Reward token for purchase
                playerNetWorth += cost;
                let coinBoostPara = document.getElementById(animalId).querySelector('p.coin-boost');
                let currentBoost = parseFloat(coinBoostPara.innerText.split('x')[1]);
                let newBoost = currentBoost + (baseCost / 1000); // Example boost calculation
                coinBoostPara.innerText = `Coin Boost: x${newBoost.toFixed(1)}`;
                showNotification(`Purchased another ${getAnimalName(animalId.replace('Special',''))}! +${Math.floor(baseRewards[getAnimalName(animalId.replace('Special',''))] * coinMultiplier)} coins.`);
                updateResources();
                checkAchievements(getAnimalName(animalId.replace('Special','')), 'animal');
                saveGame();
            } else {
                showNotification('Not enough coins!');
            }
        }
        
        // NPC Trading System
        function generateNPCs() {
            const names = ['Woody', 'Lily', 'Max', 'Bella', 'Charlie', 'Daisy', 'Rocky', 'Molly', 'Buddy', 'Lucy', 'Jack', 'Luna', 'Oliver', 'Chloe', 'Toby'];
            const categories = ['Bronze', 'Silver', 'Gold', 'Platinum', 'Diamond'];
            let npcList = [];
            categories.forEach((category, catIndex) => {
                for (let i = 0; i < 3; i++) {
                    npcList.push({
                        name: names[catIndex * 3 + i],
                        category: category,
                        contactChance: catIndex + 1, // Higher category, higher chance
                        offeredAnimal: getRandomMythicAnimal(category),
                        pet: getRandomPet(category)
                    });
                }
            });
            return npcList;
        }
        
        function getRandomMythicAnimal(category) {
            const mythicAnimals = {
                'Bronze': 'ü¶Å', // Lion
                'Silver': 'üêâ', // Dragon
                'Gold': 'ü¶Ñ',   // Unicorn
                'Platinum': 'üê≤', // Dragon
                'Diamond': 'üê∫'  // Wolf
            };
            return mythicAnimals[category] || 'ü¶ä';
        }
        
        function getRandomPet(category) {
            const pets = {
                'Bronze': { name: 'Pup', rarity: 'Common', benefit: 'moneyBoost', value: 1.1 },
                'Silver': { name: 'Kitty', rarity: 'Uncommon', benefit: 'timeBoost', value: 1.2 },
                'Gold': { name: 'Dragon', rarity: 'Rare', benefit: 'coinMultiplier', value: 1.3 },
                'Platinum': { name: 'Unicorn', rarity: 'Epic', benefit: 'allBoost', value: 1.4 },
                'Diamond': { name: 'Phoenix', rarity: 'Mythic', benefit: 'autoHarvest', value: 1.5 }
            };
            return pets[category] || { name: 'Pet', rarity: 'Common', benefit: 'none', value: 1 };
        }
        
        function renderNPCs() {
            // Currently, NPCs are auto-contacted. Implement UI if needed.
        }
        
        function startNPCAutoContact() {
            setInterval(() => {
                const chance = Math.random() * 100;
                const threshold = calculateNPCCallThreshold();
                if (chance < threshold) {
                    contactNPC();
                }
            }, 300000); // Every 5 minutes
        }
        
        function calculateNPCCallThreshold() {
            // Higher net worth increases the chance
            // Example: 1% per 1000 coins
            return Math.min(playerNetWorth / 1000, 20); // Max 20% chance
        }
        
        function contactNPC() {
            const filteredNPCs = npcs.filter(npc => Math.random() < (npc.contactChance / 10));
            if (filteredNPCs.length === 0) return;
            const npc = filteredNPCs[Math.floor(Math.random() * filteredNPCs.length)];
            openCustomModal('npcModal', `
                <h2>Trade with ${npc.name}</h2>
                <p>${npc.name} from ${npc.category} category wants to trade!</p>
                <p>Offer: ${npc.offeredAnimal} animal</p>
                <button data-npcname="${npc.name}" class="accept-trade-button">Accept</button>
                <button data-npcname="${npc.name}" class="decline-trade-button">Decline</button>
            `);
        }
        
        // Event Delegation for Modal Buttons
        document.addEventListener('click', function(event) {
            if (event.target.matches('.accept-trade-button')) {
                const npcName = event.target.getAttribute('data-npcname');
                acceptTrade(npcName);
            } else if (event.target.matches('.decline-trade-button')) {
                const npcName = event.target.getAttribute('data-npcname');
                declineTrade(npcName);
            } else if (event.target.matches('#confirmPrestigeButton')) {
                confirmPrestige();
            } else if (event.target.matches('#cancelPrestigeButton')) {
                closeModal('prestigeModal');
            } else if (event.target.matches('#restartTutorialButton')) {
                startTutorial();
                closeModal('settingsModal');
            } else if (event.target.matches('#resetProgressButton')) {
                openResetProgressModal();
            } else if (event.target.matches('#closeSettingsButton')) {
                closeModal('settingsModal');
            } else if (event.target.matches('#confirmResetButton')) {
                resetAllProgress();
                closeModal('resetProgressModal');
                showNotification('All progress has been reset.');
            } else if (event.target.matches('#cancelResetButton')) {
                closeModal('resetProgressModal');
            } else if (event.target.matches('#closeHelpButton')) {
                closeModal('helpModal');
            } else if (event.target.matches('#nextTutorialButton')) {
                nextTutorialStep();
            } else if (event.target.matches('#finishTutorialButton')) {
                endTutorial();
            }
        });
        
        function acceptTrade(npcName) {
            tokens += 5;
            coins += 500 * coinMultiplier; // Example trade deal
            playerNetWorth += 500 * coinMultiplier;
            showNotification(`Trade accepted with ${npcName}! +${Math.floor(500 * coinMultiplier)} coins and +5 tokens.`);
            checkQuests(null, 'npc');
            checkAchievements(null, 'npc');
            closeModal('npcModal');
            updateResources();
            saveGame();
        }
        
        function declineTrade(npcName) {
            showNotification(`Trade with ${npcName} declined.`);
            closeModal('npcModal');
        }
        
        // Pets System
        const availablePets = [
            { name: 'Pup', rarity: 'Common', benefit: 'moneyBoost', value: 1.1 },
            { name: 'Kitty', rarity: 'Uncommon', benefit: 'timeBoost', value: 1.2 },
            { name: 'Dragon', rarity: 'Rare', benefit: 'coinMultiplier', value: 1.3 },
            { name: 'Unicorn', rarity: 'Epic', benefit: 'allBoost', value: 1.4 },
            { name: 'Phoenix', rarity: 'Mythic', benefit: 'autoHarvest', value: 1.5 }
        ];
        
        function spinPetWheel() {
            if (tokens < 10) {
                showNotification('Not enough tokens to spin the wheel! Earn more by playing mini-games.');
                return;
            }
            tokens -= 10;
            updateResources();
            const pet = availablePets[Math.floor(Math.random() * availablePets.length)];
            ownedPets.push(pet);
            showNotification(`You received a ${pet.rarity} Pet: ${pet.name}!`);
            renderOwnedPets();
            checkQuests(null, 'minigame');
            checkAchievements(null, 'minigame');
            saveGame();
        }
        
        function renderOwnedPets() {
            const container = document.getElementById('pets-container');
            container.innerHTML = '';
            ownedPets.forEach((pet, index) => {
                let petDiv = document.createElement('div');
                petDiv.classList.add('item', 'pet-owned');
                petDiv.innerHTML = `
                    <div class="emoji">${getPetEmoji(pet.name)}</div>
                    <h3>${pet.name} (${pet.rarity})</h3>
                    <p>Benefit: ${getBenefitDescription(pet.benefit)}</p>
                    <button data-index="${index}" class="equip-pet-button">Equip</button>
                `;
                container.appendChild(petDiv);
            });
            // Add the Spin Pet Wheel button
            let spinDiv = document.createElement('div');
            spinDiv.classList.add('item', 'pet');
            spinDiv.innerHTML = `
                <h3>Spin Pet Wheel</h3>
                <p>(10 Tokens)</p>
                <button id="spinPetButton">Spin</button>
            `;
            container.appendChild(spinDiv);
            
            // Re-attach event listener for Spin button
            const spinPetButton = document.getElementById('spinPetButton');
            if (spinPetButton) {
                spinPetButton.addEventListener('click', function() {
                    spinPetWheel();
                });
            }
        }
        
        function getPetEmoji(name) {
            const map = {
                'Pup': 'üê∂',
                'Kitty': 'üê±',
                'Dragon': 'üêâ',
                'Unicorn': 'ü¶Ñ',
                'Phoenix': 'üî•'
            };
            return map[name] || 'üêæ';
        }
        
        function getBenefitDescription(benefit) {
            const map = {
                'moneyBoost': 'Increase coin earnings by 10%',
                'timeBoost': 'Decrease growth times by 10%',
                'coinMultiplier': 'Increase coin multiplier by 10%',
                'allBoost': 'Increase all earnings by 10%',
                'autoHarvest': 'Automatically harvest crops every 60s'
            };
            return map[benefit] || 'No benefit';
        }
        
        // Event Delegation for Pet Equip Buttons
        document.addEventListener('click', function(event) {
            if (event.target.matches('.equip-pet-button')) {
                const index = parseInt(event.target.getAttribute('data-index'));
                equipPet(index);
            }
        });
        
        function equipPet(index) {
            if (equippedPets.length >= 2) {
                showNotification('You can only equip 2 pets at a time.');
                return;
            }
            const pet = ownedPets[index];
            equippedPets.push(pet);
            showNotification(`${pet.name} equipped! Benefits applied.`);
            applyPetBenefits();
            renderOwnedPets();
            saveGame();
        }
        
        function applyPetBenefits() {
            equippedPets.forEach(pet => {
                switch(pet.benefit) {
                    case 'moneyBoost':
                        coinMultiplier *= pet.value;
                        break;
                    case 'timeBoost':
                        for (let crop in growthTimes) {
                            growthTimes[crop] = Math.max(1, growthTimes[crop] / pet.value);
                        }
                        break;
                    case 'coinMultiplier':
                        coinMultiplier *= pet.value;
                        break;
                    case 'allBoost':
                        coinMultiplier *= pet.value;
                        // Additional benefits can be added here
                        break;
                    case 'autoHarvest':
                        // Prevent multiple intervals
                        if (!growthTimers['autoHarvest']) {
                            growthTimers['autoHarvest'] = setInterval(() => {
                                for (let crop in baseRewards) {
                                    coins += baseRewards[crop] * coinMultiplier;
                                    playerNetWorth += baseRewards[crop] * coinMultiplier;
                                }
                                updateResources();
                                showNotification('Auto-harvested all crops! +10 coins.');
                            }, 60000); // Every 60 seconds
                        }
                        break;
                    default:
                        break;
                }
            });
            updateResources();
        }
        
        // Mini Games System
        function openMiniGame(gameName) {
            if (gameName === 'flappyFarm') {
                openFlappyFarm();
            } else if (gameName === 'memoryMatch') {
                openMemoryMatch();
            }
            // Add more mini-games as needed
        }
        
        // Initialize Mini Games
        function initializeMiniGames() {
            // Initialize Flappy Farm
            // Additional initialization can be done here
            
            // Initialize Memory Match
            // Additional initialization can be done here
        }
        
        // Flappy Farm Mini Game
        function openFlappyFarm() {
            closeAllSections();
            document.getElementById('flappyFarmSection').style.display = 'block';
            initializeFlappyFarm();
        }
        
        function backToMainFromFlappy() {
            document.getElementById('flappyFarmSection').style.display = 'none';
            showNotification('Returned to Main Game.');
        }
        
        function initializeFlappyFarm() {
            const canvas = document.getElementById('flappyCanvas');
            const ctx = canvas.getContext('2d');
            let gameOver = false;
            let score = 0;
            const startTime = Date.now();

            // Simple game loop
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'black';
                ctx.font = '30px Arial';
                ctx.fillText('Flappy Farm', 100, 100);
                ctx.fillText('Press Space to "Flap"', 50, 150);
            }

            function gameLoop() {
                if (gameOver) return;
                draw();
                // Simple timer-based scoring
                score = Math.floor((Date.now() - startTime) / 1000);
                ctx.fillText('Score: ' + score, 150, 200);
                requestAnimationFrame(gameLoop);
            }

            window.addEventListener('keydown', function(e){
                if(e.code === 'Space'){
                    alert('You flapped! Keep going...');
                }
            });

            gameLoop();

            // After a certain time, end the mini-game and reward tokens
            setTimeout(() => {
                gameOver = true;
                backToMainFromFlappy();
                tokens += 2;
                showNotification('Mini-Game Completed! +2 Tokens.');
                updateResources();
                checkQuests(null, 'minigame');
                checkAchievements(null, 'minigame');
                saveGame();
            }, 15000); // 15 seconds simulation
        }
        
        // Memory Match Mini Game
        function openMemoryMatch() {
            closeAllSections();
            document.getElementById('memoryMatchSection').style.display = 'block';
            initializeMemoryMatch();
        }
        
        function backToMainFromMemory() {
            document.getElementById('memoryMatchSection').style.display = 'none';
            showNotification('Returned to Main Game.');
        }
        
        function initializeMemoryMatch() {
            const board = document.getElementById('memoryGameBoard');
            const symbols = ['üçé','üçå','üçí','üçá','üçâ','üçì','ü•ù','üçç'];
            let cards = [...symbols, ...symbols];
            shuffle(cards);
            let firstCard = null;
            let secondCard = null;
            let lockBoard = false;
            let matchedPairs = 0;
            let gameDuration = 15000; // 15 seconds

            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            function createBoard() {
                board.innerHTML = ''; // Clear previous cards
                cards.forEach((symbol, index) => {
                    let card = document.createElement('div');
                    card.classList.add('card');
                    card.dataset.symbol = symbol;
                    card.dataset.index = index;
                    card.style.backgroundColor = '#1e90ff';
                    card.style.display = 'flex';
                    card.style.justifyContent = 'center';
                    card.style.alignItems = 'center';
                    card.style.cursor = 'pointer';
                    card.style.borderRadius = '8px';
                    card.style.fontSize = '2em';
                    card.innerText = '';
                    card.addEventListener('click', flipCard);
                    board.appendChild(card);
                });
            }

            function flipCard() {
                if (lockBoard) return;
                if (this.classList.contains('matched')) return;
                this.innerText = this.dataset.symbol;
                this.style.backgroundColor = '#ff6347';
                if (!firstCard) {
                    firstCard = this;
                    return;
                }
                secondCard = this;
                checkForMatch();
            }

            function checkForMatch() {
                let isMatch = firstCard.dataset.symbol === secondCard.dataset.symbol;
                if (isMatch) {
                    firstCard.classList.add('matched');
                    secondCard.classList.add('matched');
                    matchedPairs += 1;
                    resetCards();
                    if (matchedPairs === symbols.length) {
                        endGame(true);
                    }
                } else {
                    lockBoard = true;
                    setTimeout(() => {
                        firstCard.innerText = '';
                        firstCard.style.backgroundColor = '#1e90ff';
                        secondCard.innerText = '';
                        secondCard.style.backgroundColor = '#1e90ff';
                        resetCards();
                    }, 1000);
                }
            }

            function resetCards() {
                [firstCard, secondCard] = [null, null];
                lockBoard = false;
            }

            function endGame(win) {
                if (win) {
                    tokens += 3;
                    showNotification('Memory Game Completed! +3 Tokens.');
                } else {
                    showNotification('Memory Game Over! Try again.');
                }
                updateResources();
                checkQuests(null, 'minigame');
                checkAchievements(null, 'minigame');
                saveGame();
                backToMainFromMemory();
            }

            // Start the game
            createBoard();
            // Timer to end the game
            setTimeout(() => {
                if (matchedPairs < symbols.length) {
                    endGame(false);
                }
            }, gameDuration);
        }
        
        // Close All Sections
        function closeAllSections() {
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
        }
        
        // Prestige Confirmation Modal
        function openPrestigeModal() {
            openCustomModal('prestigeModal', `
                <h2>Confirm Prestige</h2>
                <p>Are you sure you want to reset your progress for a Prestige?</p>
                <button id="confirmPrestigeButton">Yes, Prestige</button>
                <button id="cancelPrestigeButton">Cancel</button>
            `);
        }
        
        function confirmPrestige() {
            if (coins >= 1000) {
                coins -= 1000;
                prestigeCount += 1;
                coinMultiplier += 0.5; // Increase multiplier
                updateResources();
                updatePrestige();
                showNotification('Prestige achieved! ‚ú® Coin rewards increased by 50%.');
                checkAchievements(null, 'prestige');
                resetGame(false);
                closeModal('prestigeModal');
                saveGame();
            } else {
                showNotification('Not enough coins to prestige!');
            }
        }
        
        // Settings Modal Functions
        function openSettingsModal() {
            openCustomModal('settingsModal', `
                <h2>Settings</h2>
                <button id="restartTutorialButton">Restart Tutorial</button>
                <button id="resetProgressButton">Restart Progress</button>
                <button id="closeSettingsButton">Close</button>
            `);
        }
        
        function openResetProgressModal() {
            openCustomModal('resetProgressModal', `
                <h2>Confirm Reset</h2>
                <p>Are you sure you want to reset all your progress?</p>
                <button id="confirmResetButton">Yes, Reset</button>
                <button id="cancelResetButton">Cancel</button>
            `);
        }
        
        function resetAllProgress() {
            resetGame(true);
            closeModal('resetProgressModal');
            showNotification('All progress has been reset.');
        }
        
        // Help Modal Functions
        function openHelpModal() {
            openCustomModal('helpModal', `
                <h2>Help & Information</h2>
                <p>Welcome to Idle Farm! Here's how to play:</p>
                <ul>
                    <li><strong>Crops:</strong> Click on crops to grow them. Once grown, collect coins.</li>
                    <li><strong>Animals:</strong> Raise animals to produce products. Click to collect coins.</li>
                    <li><strong>Upgrades:</strong> Purchase upgrades to enhance production and reduce growth times.</li>
                    <li><strong>Passive Farms:</strong> Buy passive farms that generate coins automatically at intervals.</li>
                    <li><strong>Decorations:</strong> Beautify your farm with decorations. No gameplay effect.</li>
                    <li><strong>Quests:</strong> Complete quests to earn additional rewards.</li>
                    <li><strong>Achievements:</strong> Unlock achievements based on your progress.</li>
                    <li><strong>Pets:</strong> Spin the pet wheel to collect pets that provide various benefits.</li>
                    <li><strong>Black Market:</strong> Purchase rare animals that boost your earnings.</li>
                    <li><strong>Mini Games:</strong> Play mini-games to earn tokens.</li>
                    <li><strong>Prestige:</strong> Reset your progress for increased multipliers and long-term rewards.</li>
                    <li><strong>Settings:</strong> Access settings to restart the tutorial or reset your progress.</li>
                </ul>
                <button id="closeHelpButton">Close</button>
            `);
        }
        
        // Custom Modal Functions
        function openCustomModal(modalId, content) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.querySelector('.modal-content').innerHTML = `
                    <span class="close" data-close="${modalId}">&times;</span>
                    ${content}
                `;
                modal.style.display = 'flex';
            } else {
                console.error(`Modal with ID "${modalId}" not found.`);
            }
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            } else {
                console.error(`Modal with ID "${modalId}" not found.`);
            }
        }
        
        // Settings Tutorial Restart
        function startTutorial() {
            isTutorialActive = true;
            tutorialStep = 1;
            openCustomModal('tutorialModal', `
                <h2>Welcome to Idle Farm!</h2>
                <p>Let's get you started with a quick tutorial.</p>
                <button id="nextTutorialButton">Next</button>
            `);
        }
        
        // Tutorial Functions
        function checkAndStartTutorial() {
            const hasCompletedTutorial = localStorage.getItem('completedTutorial');
            if (!hasCompletedTutorial) {
                startTutorial();
            }
        }
        
        function nextTutorialStep() {
            const modalContent = document.querySelector('#tutorialModal .modal-content');
            switch(tutorialStep) {
                case 1:
                    modalContent.innerHTML = `
                        <span class="close" data-close="tutorialModal">&times;</span>
                        <h2>Harvest Crops</h2>
                        <p>Click on the crops to start growing them. Once grown, collect coins!</p>
                        <button id="nextTutorialButton">Next</button>
                    `;
                    break;
                case 2:
                    modalContent.innerHTML = `
                        <span class="close" data-close="tutorialModal">&times;</span>
                        <h2>Raise Animals</h2>
                        <p>Click on animals to produce products. Collect them to earn more coins!</p>
                        <button id="nextTutorialButton">Next</button>
                    `;
                    break;
                case 3:
                    modalContent.innerHTML = `
                        <span class="close" data-close="tutorialModal">&times;</span>
                        <h2>Purchase Upgrades</h2>
                        <p>Buy upgrades to enhance your farm's efficiency and increase rewards.</p>
                        <button id="nextTutorialButton">Next</button>
                    `;
                    break;
                case 4:
                    modalContent.innerHTML = `
                        <span class="close" data-close="tutorialModal">&times;</span>
                        <h2>Earn Passive Income</h2>
                        <p>Invest in passive farms to generate coins automatically, even when you're not actively playing.</p>
                        <button id="nextTutorialButton">Next</button>
                    `;
                    break;
                case 5:
                    modalContent.innerHTML = `
                        <span class="close" data-close="tutorialModal">&times;</span>
                        <h2>Complete Quests and Achievements</h2>
                        <p>Complete quests and unlock achievements to earn additional rewards and showcase your progress.</p>
                        <button id="finishTutorialButton">Finish Tutorial</button>
                    `;
                    break;
                default:
                    break;
            }
            tutorialStep++;
        }
        
        function endTutorial() {
            closeModal('tutorialModal');
            localStorage.setItem('completedTutorial', true);
            isTutorialActive = false;
            showNotification('Tutorial Completed! Enjoy your farming journey! üöúüå±');
        }
        
        // NPC Trading System Helper
        function getAnimalName(emoji) {
            const map = {
                'üê∂': 'dog',
                'üê±': 'cat',
                'ü¶ä': 'fox',
                'üê∞': 'rabbit',
                'üêª': 'bear',
                'ü¶Å': 'lion',
                'üêâ': 'dragon',
                'ü¶Ñ': 'unicorn',
                'üê≤': 'dragon',
                'üê∫': 'wolf'
            };
            return map[emoji] || 'animal';
        }
        
        // Save Owned Passive Farms
        function getOwnedPassiveFarms() {
            let owned = [];
            document.querySelectorAll('.passive-farm.owned').forEach(el => owned.push(el.getAttribute('data-farm')));
            return owned;
        }
        
        // Reset Game Function
        function resetGame(completeReset = true) {
            // Clear growth timers
            for (let key in growthTimers) {
                clearTimeout(growthTimers[key]);
            }
            growthTimers = {};
            
            // Clear passive timers
            for (let key in passiveTimers) {
                clearInterval(passiveTimers[key]);
            }
            passiveTimers = {};
            
            // Reset variables
            coins = 0;
            gems = 0;
            tokens = 0;
            growthTimes = {
                wheat: 5,
                corn: 8,
                pumpkin: 12,
                tomato: 7,
                carrot: 6,
                chicken: 10,
                cow: 15,
                sheep: 20,
                goat: 18,
                duck: 12,
                pig: 25
            };
            if (completeReset) {
                achievements = {};
                completedQuests = [];
                coinMultiplier = 1;
                document.querySelectorAll('.passive-farm').forEach(el => el.classList.remove('owned'));
                document.querySelectorAll('.count').forEach(el => el.innerText = '0');
                document.querySelectorAll('.coin-boost').forEach(el => el.innerText = 'Coin Boost: x1');
                ownedPets = [];
                equippedPets = [];
                renderOwnedPets();
                localStorage.removeItem('completedTutorial');
            }
            updateResources();
            generateQuests();
            generateAchievements();
            renderQuests();
            renderAchievements();
            renderBlackMarket();
            updatePrestige();
            startPassiveIncome();
        }
        
        // Save and Load Game State
        function saveGame() {
            const gameState = {
                coins,
                gems,
                tokens,
                growthTimes,
                prestigeCount,
                coinMultiplier,
                achievements,
                completedQuests,
                passiveFarms: getOwnedPassiveFarms(),
                theme,
                dailyBonusClaimed,
                playerNetWorth,
                ownedPets,
                equippedPets
            };
            localStorage.setItem('idleFarmGameState', JSON.stringify(gameState));
        }
        
        function loadGame() {
            const savedState = JSON.parse(localStorage.getItem('idleFarmGameState'));
            if (savedState) {
                coins = savedState.coins || 0;
                gems = savedState.gems || 0;
                tokens = savedState.tokens || 0;
                growthTimes = savedState.growthTimes || growthTimes;
                prestigeCount = savedState.prestigeCount || 0;
                coinMultiplier = savedState.coinMultiplier || 1;
                achievements = savedState.achievements || {};
                completedQuests = savedState.completedQuests || [];
                theme = savedState.theme || 'light';
                dailyBonusClaimed = savedState.dailyBonusClaimed || false;
                playerNetWorth = savedState.playerNetWorth || 0;
                ownedPets = savedState.ownedPets || [];
                equippedPets = savedState.equippedPets || [];
                
                // Restore passive farms
                if (savedState.passiveFarms) {
                    savedState.passiveFarms.forEach(id => {
                        const farmElement = document.querySelector(`.passive-farm[data-farm="${id}"]`);
                        if (farmElement) {
                            farmElement.classList.add('owned');
                        }
                    });
                }
                
                updateResources();
            }
        }
        
        // In-Game Notifications
        function showNotification(message) {
            if (document.querySelectorAll('.notification').length >= 3) return;
            let notification = document.createElement('div');
            notification.classList.add('notification');
            notification.innerText = message;
            document.getElementById('notification-container').appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 100);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    notification.remove();
                }, 500);
            }, 3000);
        }
        
        // Toggle Focus Mode
        function toggleFocusMode() {
            focusMode = !focusMode;
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                const sectionTitle = section.querySelector('h2')?.innerText;
                if (focusMode) {
                    if (!['Crops üå±', 'Animals üêÑ', 'Upgrades üöú', 'Passive Farms üåæ', 'Decorations üé®', 'Quests üéØ', 'Achievements üèÜ', 'Pets üêæ', 'Black Market üí±', 'Mini Games üïπÔ∏è', 'Prestige ‚ú®', 'Settings ‚öôÔ∏è', 'Help ‚ùì'].includes(sectionTitle)) {
                        section.style.display = 'none';
                    }
                } else {
                    section.style.display = 'block';
                }
            });
            document.getElementById('focus-mode-toggle').innerText = focusMode ? 'üîì' : 'üîí';
            saveGame();
        }
        
        // Toggle Theme
        function toggleTheme() {
            theme = (theme === 'light') ? 'dark' : 'light';
            updateTheme();
            saveGame();
        }
        
        function updateTheme() {
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }
        
        // Daily Bonus System
        function checkDailyBonus() {
            const lastLogin = localStorage.getItem('lastLogin');
            const today = new Date().toDateString();
            if (lastLogin !== today && !dailyBonusClaimed) {
                showDailyBonus();
                localStorage.setItem('lastLogin', today);
            }
        }
        
        function showDailyBonus() {
            gems += 5;
            showNotification('Daily Bonus! +5 Gems! üåü');
            dailyBonusClaimed = true;
            updateResources();
            saveGame();
        }
        
        // Reset Daily Bonus
        function resetDailyBonus() {
            dailyBonusClaimed = false;
        }
        
        // Automatically reset daily bonus at midnight
        setInterval(() => {
            const now = new Date();
            if (now.getHours() === 0 && now.getMinutes() === 0) {
                resetDailyBonus();
            }
        }, 60000); // Check every minute
        
        // Strategy Tips
        function showStrategyTip() {
            const tips = [
                "Focus on upgrading wheat and chicken early to maximize your income.",
                "Invest in passive farms to earn coins even when you're not actively playing.",
                "Complete daily quests for additional rewards and progression.",
                "Prestiging can significantly boost your coin earnings over time.",
                "Balance your investments between crops and animals for steady income."
            ];
            const randomTip = tips[Math.floor(Math.random() * tips.length)];
            showNotification(`Strategy Tip: ${randomTip}`);
        }
        
        // Periodically show strategy tips
        setInterval(showStrategyTip, 300000); // Every 5 minutes
        
        // Capitalize Function
        function capitalize(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        // Accessibility: Keyboard Navigation
        document.addEventListener('keydown', function(event) {
            switch(event.key.toLowerCase()) {
                case 'c':
                    document.querySelector('.section:nth-of-type(1)').scrollIntoView({ behavior: 'smooth' });
                    break;
                case 'a':
                    document.querySelector('.section:nth-of-type(2)').scrollIntoView({ behavior: 'smooth' });
                    break;
                case 'u':
                    document.querySelector('.section:nth-of-type(3)').scrollIntoView({ behavior: 'smooth' });
                    break;
                case 'p':
                    document.querySelector('.section:nth-of-type(10)').scrollIntoView({ behavior: 'smooth' });
                    break;
                case 'd':
                    document.querySelector('.section:nth-of-type(5)').scrollIntoView({ behavior: 'smooth' });
                    break;
                case 'q':
                    document.querySelector('.section:nth-of-type(7)').scrollIntoView({ behavior: 'smooth' });
                    break;
                case 'm':
                    document.querySelector('.section:nth-of-type(9)').scrollIntoView({ behavior: 'smooth' });
                    break;
                default:
                    break;
            }
        });
        
        // Auto-Save Functionality and Notification
        function showAutoSaveNotification() {
            setInterval(() => {
                saveGame();
                const notification = document.getElementById('auto-save-notification');
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.opacity = '1';
                    setTimeout(() => {
                        notification.style.opacity = '0';
                        setTimeout(() => {
                            notification.style.display = 'none';
                        }, 500);
                    }, 500);
                }, 100);
            }, 10000); // Auto-save every 10 seconds
        }
        
        // Credits Section
        function renderCredits() {
            const container = document.querySelector('.container');
            let creditsDiv = document.createElement('div');
            creditsDiv.classList.add('credits');
            creditsDiv.innerHTML = `
                <p>Game developed by <a href="https://github.com/Static" target="_blank">Static</a></p>
            `;
            container.appendChild(creditsDiv);
        }
    </script>
</body>
</html>
